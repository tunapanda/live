#!/bin/bash -x 

LIB="$(dirname ${BASH_SOURCE[0]})"/lib.sh
if [ ! -e $LIB ] 
then 
	echo "ERROR: Required file not found: $LIB" >&2
	exit 1
else
	source $LIB
fi
require_root

TPDIR=$(basedir)
RMSDIR=$TPDIR/../remastersys/ISOTMP
SQUASHROOT=$TPDIR/FS-root
INITDIR=$TPDIR/Initrd-root
LIVEDIR=$TPDIR/Livecd-root
ISODIR=$TPDIR/Completed
DATESTAMP=$(date +%Y%m%d%H%M)

function mksquashfs() {
	sudo remastersys backup cdfs
	sudo mv $RMSDIR/casper/filesystem.* $LIVEDIR/casper/ || fail
}

function mkiso() {
	[ -e $ISODIR ] || mkdir $ISODIR || fail

	# Recalc md5sums
	pushd $LIVEDIR ||  fail
	sudo rm md5sum.txt 	find -type f -print0 | sudo xargs -0 md5sum | grep -v isolinux/boot.cat | sudo tee md5sum.txt 
	popd 

	pushd $LIVEDIR ||  fail
	mkisofs -m '.fuse_*' -D -r -V "Tunapanda-$DATESTAMP" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o $ISODIR/tunapanda-${DATESTAMP}.iso . ||  fail
	popd 
}

$TPDIR/Scripts/env_setup.sh || fail

if [ $# -eq 0 ] || echo $@ | grep "squashfs" &> /dev/null
then
	echo "WTF" ; exit 4
	mksquashfs || fail
fi

if [ $# -eq 0 ] || echo $@ | grep "iso" &> /dev/null
then
	echo "DVD version $DATESTAMP" > $LIVEDIR/tunapanda/VERSION.txt
	mkiso || fail
fi


pushd $TPDIR
popd
